<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>پنل مدیریت</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1>داشبورد مدیریت</h1>
            <a href="/logout">خروج</a>
        </header>

        <div class="card">
            <h2>ساخت اتاق جدید</h2>
            <form id="create-room-form" class="form-inline">
                <input type="text" id="room-name-input" placeholder="نام اتاق (انگلیسی، بدون فاصله)" required>
                <button type="submit">ساخت اتاق</button>
            </form>
        </div>

        <div id="rooms-management-container">
            </div>
    </div>

<script>
    const createRoomForm = document.getElementById('create-room-form');
    const roomsContainer = document.getElementById('rooms-management-container');
    const socket = io();
    
    let adminData = {
        rooms: [],
        users: [],
        currentUserId: null,
        isSuperAdmin: false
    };

    // --- توابع API ---
    const api = {
        get: (url) => fetch(url).then(res => res.ok ? res.json() : Promise.reject(res)),
        post: (url, body) => fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        put: (url, body) => fetch(url, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        // متد حذف برای اتاق‌ها (بدون body) و لینک‌ها (با body)
        delete: (url, body) => fetch(url, { 
            method: 'DELETE', 
            headers: body ? {'Content-Type': 'application/json'} : {}, 
            body: body ? JSON.stringify(body) : null 
        }).then(res => res.ok ? res.json() : Promise.reject(res)),
    };
    
    // --- توابع رندر کردن ---
    function renderDashboard() {
        roomsContainer.innerHTML = '';
        adminData.rooms.forEach(room => {
            const roomCard = document.createElement('div');
            roomCard.className = 'card room-card';
            roomCard.id = `room-card-${room.id}`;
            roomCard.innerHTML = renderRoomToString(room);
            roomsContainer.appendChild(roomCard);
        });
    }

    function renderRoomToString(room) {
        // نمایش دکمه حذف اتاق برای تمام کاربران دارای دسترسی
        const deleteButtonHTML = `<button class="delete-room-btn" data-room-id="${room.id}">حذف اتاق</button>`;

        return `
            <div class="room-header">
                <h3>اتاق: ${room.name}</h3>
                <div class="room-actions">
                     <a href="/${room.name}" target="_blank">مشاهده</a>
                     ${deleteButtonHTML}
                </div>
            </div>
            <div class="links-list">
                ${room.links.map(renderLinkToString).join('')}
            </div>
            <form class="add-link-form form-inline" data-room-id="${room.id}">
                <input type="url" placeholder="URL جدید" required>
                <button type="submit">افزودن لینک</button>
            </form>
            ${adminData.isSuperAdmin ? renderPermissionsSection(room) : ''}
        `;
    }

    function renderLinkToString(link) {
        return `
            <div class="link-admin-item" id="admin-link-${link.id}">
                <span>${link.url}</span>
                <div class="controls">
                    <select class="status-changer" data-id="${link.id}">
                        <option value="available" ${link.status === 'available' ? 'selected' : ''}>خالی</option>
                        <option value="filling" ${link.status === 'filling' ? 'selected' : ''}>درحال پر شدن</option>
                        <option value="full" ${link.status === 'full' ? 'selected' : ''}>اتمام ظرفیت</option>
                    </select>
                    <button class="delete-link-btn" data-id="${link.id}">🗑️</button>
                </div>
            </div>
        `;
    }

    function renderPermissionsSection(room) {
        if (!adminData.users || adminData.users.length === 0) return '';
        const userCheckboxes = adminData.users.map(user => `
            <div class="permission-item">
                <input type="checkbox" class="permission-checkbox" 
                       id="perm-room${room.id}-user${user.id}"
                       data-room-id="${room.id}" 
                       data-user-id="${user.id}"
                       ${room.permittedUsers.includes(user.id) ? 'checked' : ''}>
                <label for="perm-room${room.id}-user${user.id}">${user.username}</label>
            </div>
        `).join('');
        return `<div class="permissions-section"><h4>مدیریت دسترسی</h4><div class="permissions-list">${userCheckboxes}</div></div>`;
    }

    // --- مدیریت رویدادها ---
    createRoomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('room-name-input');
        try {
            // فقط درخواست را ارسال می‌کنیم، آپدیت صفحه توسط سوکت انجام می‌شود
            await api.post('/api/rooms', { name: input.value });
            input.value = '';
        } catch (err) {
            alert('خطا در ساخت اتاق. ممکن است نام تکراری باشد.');
        }
    });

    roomsContainer.addEventListener('click', async (e) => {
        // رویداد حذف لینک
        if (e.target.classList.contains('delete-link-btn')) {
            const linkId = e.target.dataset.id;
            if (confirm('آیا از حذف این لینک مطمئن هستید؟')) {
                api.delete(`/api/links/${linkId}`).catch(() => alert('خطا در حذف لینک.'));
            }
        }
        // رویداد حذف اتاق
        if (e.target.classList.contains('delete-room-btn')) {
            const roomId = e.target.dataset.roomId;
            if (confirm(`آیا از حذف اتاق با آیدی ${roomId} و تمام لینک‌های آن مطمئن هستید؟`)) {
                api.delete(`/api/rooms/${roomId}`).catch(() => alert('خطا در حذف اتاق.'));
            }
        }
    });

    // سایر رویدادها (افزودن لینک، تغییر وضعیت و دسترسی)
    roomsContainer.addEventListener('submit', async e => { /* ... کد مشابه قبل ... */ });
    roomsContainer.addEventListener('change', async e => { /* ... کد مشابه قبل ... */ });


    // --- منطق ریل-تایم با سوکت ---

    // گوش دادن به رویداد اضافه شدن اتاق
    socket.on('room_added', (newRoom) => {
        console.log('Room added or permission granted:', newRoom);
        const existingIndex = adminData.rooms.findIndex(r => r.id === newRoom.id);
        if (existingIndex > -1) {
            adminData.rooms[existingIndex] = newRoom; // آپدیت اتاق موجود
        } else {
            adminData.rooms.push(newRoom); // اضافه کردن اتاق جدید
            adminData.rooms.sort((a, b) => a.name.localeCompare(b.name)); // مرتب‌سازی
        }
        renderDashboard();
    });

    // گوش دادن به رویداد حذف شدن اتاق
    socket.on('room_deleted', (data) => {
        console.log('Room deleted or permission revoked:', data);
        adminData.rooms = adminData.rooms.filter(r => r.id !== data.roomId);
        renderDashboard();
    });


    // --- بارگذاری اولیه داده‌ها ---
    async function loadAdminData() {
        try {
            adminData = await api.get('/api/admin/data');
            renderDashboard();
            // اتصال ادمین به روم شخصی خودش در سوکت
            socket.emit('admin_join', adminData.currentUserId);
        } catch (error) {
            window.location.href = '/login.html';
        }
    }

    loadAdminData();

</script>
</body>
</html>