<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>پنل مدیریت</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1>داشبورد مدیریت</h1>
            <a href="/logout">خروج</a>
        </header>

        <div class="card">
            <h2>ساخت اتاق جدید</h2>
            <form id="create-room-form" class="form-inline">
                <input type="text" id="room-name-input" placeholder="نام اتاق (انگلیسی، بدون فاصله)" required>
                <button type="submit">ساخت اتاق</button>
            </form>
        </div>

        <div id="rooms-management-container"></div>
    </div>

<script>
    const createRoomForm = document.getElementById('create-room-form');
    const roomsContainer = document.getElementById('rooms-management-container');
    const socket = io();
    
    let adminData = {
        rooms: [],
        users: [],
        currentUserId: null,
        isSuperAdmin: false
    };

    const api = {
        get: (url) => fetch(url).then(res => res.ok ? res.json() : Promise.reject(res)),
        post: (url, body) => fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        put: (url, body) => fetch(url, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        delete: (url, body) => fetch(url, { method: 'DELETE', headers: body ? {'Content-Type': 'application/json'} : {}, body: body ? JSON.stringify(body) : null }).then(res => res.ok ? res.json() : Promise.reject(res)),
    };
    
    function renderDashboard() {
        const newContent = document.createDocumentFragment();
        adminData.rooms.forEach(room => {
            const roomCard = document.createElement('div');
            roomCard.className = 'card room-card';
            roomCard.id = `room-card-${room.id}`;
            roomCard.innerHTML = renderRoomToString(room);
            newContent.appendChild(roomCard);
        });
        roomsContainer.innerHTML = '';
        roomsContainer.appendChild(newContent);
    }

    function renderRoomToString(room) {
        const creator = adminData.users.find(u => u.id === room.user_id)?.username || 'ناشناس';
        const creatorBadge = adminData.isSuperAdmin ? `<span class="creator-badge">سازنده: ${creator}</span>` : '';
        return `
            <div class="room-header">
                <h3>اتاق: ${room.name} ${creatorBadge}</h3>
                <div class="room-actions">
                     <a href="/${room.name}" target="_blank">مشاهده</a>
                     <button class="delete-room-btn" data-room-id="${room.id}">حذف اتاق</button>
                </div>
            </div>
            <div class="links-list">
                ${room.links.map(renderLinkToString).join('')}
            </div>
            <form class="add-link-form form-inline" data-room-id="${room.id}">
                <input type="url" placeholder="URL جدید" required>
                <button type="submit">افزودن لینک</button>
            </form>
            ${adminData.isSuperAdmin ? renderPermissionsSection(room) : ''}
        `;
    }

    function renderLinkToString(link) {
        return `
            <div class="link-admin-item" id="admin-link-${link.id}">
                <span>${link.url}</span>
                <div class="controls">
                    <select class="status-changer" data-id="${link.id}">
                        <option value="available" ${link.status === 'available' ? 'selected' : ''}>خالی</option>
                        <option value="filling" ${link.status === 'filling' ? 'selected' : ''}>درحال پر شدن</option>
                        <option value="full" ${link.status === 'full' ? 'selected' : ''}>اتمام ظرفیت</option>
                    </select>
                    <button class="delete-link-btn" data-id="${link.id}">🗑️</button>
                </div>
            </div>
        `;
    }

    function renderPermissionsSection(room) {
        if (!adminData.users || adminData.users.length === 0) return '';
        const userCheckboxes = adminData.users.map(user => `
            <div class="permission-item">
                <input type="checkbox" class="permission-checkbox" 
                       id="perm-room${room.id}-user${user.id}"
                       data-room-id="${room.id}" 
                       data-user-id="${user.id}"
                       ${room.permittedUsers.includes(user.id) ? 'checked' : ''}>
                <label for="perm-room${room.id}-user${user.id}">${user.username}</label>
            </div>
        `).join('');
        return `<div class="permissions-section"><h4>مدیریت دسترسی</h4><div class="permissions-list">${userCheckboxes}</div></div>`;
    }

    // --- Event Handlers (sends requests, UI updates are handled by socket listeners) ---
    createRoomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('room-name-input');
        api.post('/api/rooms', { name: input.value })
            .then(() => input.value = '')
            .catch(() => alert('خطا در ساخت اتاق.'));
    });
    
    roomsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-link-btn')) {
            const linkId = e.target.dataset.id;
            if (confirm('آیا از حذف این لینک مطمئن هستید؟')) {
                api.delete(`/api/links/${linkId}`).catch(() => alert('خطا در حذف لینک.'));
            }
        }
        if (e.target.classList.contains('delete-room-btn')) {
            const roomId = e.target.dataset.roomId;
            if (confirm(`آیا از حذف این اتاق و تمام محتویات آن مطمئن هستید؟`)) {
                api.delete(`/api/rooms/${roomId}`).catch(() => alert('خطا در حذف اتاق.'));
            }
        }
    });

    roomsContainer.addEventListener('submit', (e) => {
        if (e.target.classList.contains('add-link-form')) {
            e.preventDefault();
            const form = e.target;
            const roomId = form.dataset.roomId;
            const urlInput = form.querySelector('input[type="url"]');
            api.post('/api/links', { roomId, url: urlInput.value })
               .then(() => form.reset())
               .catch(() => alert('خطا در افزودن لینک.'));
        }
    });

    roomsContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('status-changer')) {
            const linkId = e.target.dataset.id;
            const newStatus = e.target.value;
            api.put(`/api/links/${linkId}`, { status: newStatus }).catch(() => alert('خطا در تغییر وضعیت.'));
        }
        if (e.target.classList.contains('permission-checkbox')) {
            const checkbox = e.target;
            const payload = { userId: checkbox.dataset.userId, roomId: checkbox.dataset.roomId };
            const action = checkbox.checked ? api.post('/api/permissions', payload) : api.delete('/api/permissions', payload);
            action.catch(() => {
                alert('خطا در تغییر دسترسی.');
                checkbox.checked = !checkbox.checked;
            });
        }
    });

    // --- Socket Listeners (handles all UI updates) ---
    socket.on('room_updated', (updatedRoom) => {
        const index = adminData.rooms.findIndex(r => r.id === updatedRoom.id);
        if (index > -1) {
            adminData.rooms[index] = updatedRoom;
        } else {
            adminData.rooms.push(updatedRoom);
        }
        adminData.rooms.sort((a, b) => a.name.localeCompare(b.name));
        renderDashboard();
    });

    socket.on('room_deleted', (data) => {
        adminData.rooms = adminData.rooms.filter(r => r.id !== data.roomId);
        renderDashboard();
    });

    // --- Initial Load ---
    async function loadAdminData() {
        try {
            adminData = await api.get('/api/admin/data');
            renderDashboard();
            socket.emit('admin_join', adminData.currentUserId);
        } catch (error) {
            window.location.href = '/login.html';
        }
    }

    loadAdminData();
</script>
</body>
</html>