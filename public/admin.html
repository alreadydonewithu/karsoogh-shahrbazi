<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
            <a href="/logout">Ø®Ø±ÙˆØ¬</a>
        </header>

        <div class="card">
            <h2>Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</h2>
            <form id="create-room-form" class="form-inline">
                <input type="text" id="room-name-input" placeholder="Ù†Ø§Ù… Ø§ØªØ§Ù‚ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø¨Ø¯ÙˆÙ† ÙØ§ØµÙ„Ù‡)" required>
                <button type="submit">Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚</button>
            </form>
        </div>

        <div id="rooms-management-container">
            </div>
    </div>

<script>
    const createRoomForm = document.getElementById('create-room-form');
    const roomsContainer = document.getElementById('rooms-management-container');
    const socket = io();
    
    let adminData = {
        rooms: [],
        users: [],
        currentUserId: null,
        isSuperAdmin: false
    };

    // --- ØªÙˆØ§Ø¨Ø¹ API ---
    const api = {
        get: (url) => fetch(url).then(res => res.ok ? res.json() : Promise.reject(res)),
        post: (url, body) => fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        put: (url, body) => fetch(url, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }).then(res => res.ok ? res.json() : Promise.reject(res)),
        // Ù…ØªØ¯ Ø­Ø°Ù Ø¨Ø±Ø§ÛŒ Ø§ØªØ§Ù‚â€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† body) Ùˆ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ (Ø¨Ø§ body)
        delete: (url, body) => fetch(url, { 
            method: 'DELETE', 
            headers: body ? {'Content-Type': 'application/json'} : {}, 
            body: body ? JSON.stringify(body) : null 
        }).then(res => res.ok ? res.json() : Promise.reject(res)),
    };
    
    // --- ØªÙˆØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† ---
    function renderDashboard() {
        roomsContainer.innerHTML = '';
        adminData.rooms.forEach(room => {
            const roomCard = document.createElement('div');
            roomCard.className = 'card room-card';
            roomCard.id = `room-card-${room.id}`;
            roomCard.innerHTML = renderRoomToString(room);
            roomsContainer.appendChild(roomCard);
        });
    }

    function renderRoomToString(room) {
        // Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø§ØªØ§Ù‚ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø§Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ
        const deleteButtonHTML = `<button class="delete-room-btn" data-room-id="${room.id}">Ø­Ø°Ù Ø§ØªØ§Ù‚</button>`;

        return `
            <div class="room-header">
                <h3>Ø§ØªØ§Ù‚: ${room.name}</h3>
                <div class="room-actions">
                     <a href="/${room.name}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
                     ${deleteButtonHTML}
                </div>
            </div>
            <div class="links-list">
                ${room.links.map(renderLinkToString).join('')}
            </div>
            <form class="add-link-form form-inline" data-room-id="${room.id}">
                <input type="url" placeholder="URL Ø¬Ø¯ÛŒØ¯" required>
                <button type="submit">Ø§ÙØ²ÙˆØ¯Ù† Ù„ÛŒÙ†Ú©</button>
            </form>
            ${adminData.isSuperAdmin ? renderPermissionsSection(room) : ''}
        `;
    }

    function renderLinkToString(link) {
        return `
            <div class="link-admin-item" id="admin-link-${link.id}">
                <span>${link.url}</span>
                <div class="controls">
                    <select class="status-changer" data-id="${link.id}">
                        <option value="available" ${link.status === 'available' ? 'selected' : ''}>Ø®Ø§Ù„ÛŒ</option>
                        <option value="filling" ${link.status === 'filling' ? 'selected' : ''}>Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø± Ø´Ø¯Ù†</option>
                        <option value="full" ${link.status === 'full' ? 'selected' : ''}>Ø§ØªÙ…Ø§Ù… Ø¸Ø±ÙÛŒØª</option>
                    </select>
                    <button class="delete-link-btn" data-id="${link.id}">ğŸ—‘ï¸</button>
                </div>
            </div>
        `;
    }

    function renderPermissionsSection(room) {
        if (!adminData.users || adminData.users.length === 0) return '';
        const userCheckboxes = adminData.users.map(user => `
            <div class="permission-item">
                <input type="checkbox" class="permission-checkbox" 
                       id="perm-room${room.id}-user${user.id}"
                       data-room-id="${room.id}" 
                       data-user-id="${user.id}"
                       ${room.permittedUsers.includes(user.id) ? 'checked' : ''}>
                <label for="perm-room${room.id}-user${user.id}">${user.username}</label>
            </div>
        `).join('');
        return `<div class="permissions-section"><h4>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ</h4><div class="permissions-list">${userCheckboxes}</div></div>`;
    }

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ---
    createRoomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('room-name-input');
        try {
            // ÙÙ‚Ø· Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ Ø¢Ù¾Ø¯ÛŒØª ØµÙØ­Ù‡ ØªÙˆØ³Ø· Ø³ÙˆÚ©Øª Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯
            await api.post('/api/rooms', { name: input.value });
            input.value = '';
        } catch (err) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†Ø§Ù… ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ø§Ø´Ø¯.');
        }
    });

    roomsContainer.addEventListener('click', async (e) => {
        // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø­Ø°Ù Ù„ÛŒÙ†Ú©
        if (e.target.classList.contains('delete-link-btn')) {
            const linkId = e.target.dataset.id;
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                api.delete(`/api/links/${linkId}`).catch(() => alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù„ÛŒÙ†Ú©.'));
            }
        }
        // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø­Ø°Ù Ø§ØªØ§Ù‚
        if (e.target.classList.contains('delete-room-btn')) {
            const roomId = e.target.dataset.roomId;
            if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ØªØ§Ù‚ Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ ${roomId} Ùˆ ØªÙ…Ø§Ù… Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¢Ù† Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) {
                api.delete(`/api/rooms/${roomId}`).catch(() => alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§ØªØ§Ù‚.'));
            }
        }
    });

    // Ø³Ø§ÛŒØ± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (Ø§ÙØ²ÙˆØ¯Ù† Ù„ÛŒÙ†Ú©ØŒ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ)
    roomsContainer.addEventListener('submit', async e => { /* ... Ú©Ø¯ Ù…Ø´Ø§Ø¨Ù‡ Ù‚Ø¨Ù„ ... */ });
    roomsContainer.addEventListener('change', async e => { /* ... Ú©Ø¯ Ù…Ø´Ø§Ø¨Ù‡ Ù‚Ø¨Ù„ ... */ });


    // --- Ù…Ù†Ø·Ù‚ Ø±ÛŒÙ„-ØªØ§ÛŒÙ… Ø¨Ø§ Ø³ÙˆÚ©Øª ---

    // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø§ØªØ§Ù‚
    socket.on('room_added', (newRoom) => {
        console.log('Room added or permission granted:', newRoom);
        const existingIndex = adminData.rooms.findIndex(r => r.id === newRoom.id);
        if (existingIndex > -1) {
            adminData.rooms[existingIndex] = newRoom; // Ø¢Ù¾Ø¯ÛŒØª Ø§ØªØ§Ù‚ Ù…ÙˆØ¬ÙˆØ¯
        } else {
            adminData.rooms.push(newRoom); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯
            adminData.rooms.sort((a, b) => a.name.localeCompare(b.name)); // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
        }
        renderDashboard();
    });

    // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø­Ø°Ù Ø´Ø¯Ù† Ø§ØªØ§Ù‚
    socket.on('room_deleted', (data) => {
        console.log('Room deleted or permission revoked:', data);
        adminData.rooms = adminData.rooms.filter(r => r.id !== data.roomId);
        renderDashboard();
    });


    // --- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ---
    async function loadAdminData() {
        try {
            adminData = await api.get('/api/admin/data');
            renderDashboard();
            // Ø§ØªØµØ§Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ù‡ Ø±ÙˆÙ… Ø´Ø®ØµÛŒ Ø®ÙˆØ¯Ø´ Ø¯Ø± Ø³ÙˆÚ©Øª
            socket.emit('admin_join', adminData.currentUserId);
        } catch (error) {
            window.location.href = '/login.html';
        }
    }

    loadAdminData();

</script>
</body>
</html>